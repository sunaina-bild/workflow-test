name: Test Env File Logic

on:
  workflow_dispatch:
    inputs:
      additional_env_vars:
        description: "Extra vars (comma separated KEY=VALUE)"
        required: false
        

jobs:
  test-env-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Mask inputs
        run: |
          echo "::add-mask::${{ vars.ENV_CONFIG }}"
          echo "::add-mask::${{ github.event.inputs.additional_env_vars }}"

      - name: Prepare env file
        run: |
          mkdir -p envs
          echo "${{ vars.ENV_CONFIG }}" > envs/.env
          
          if [ -n "${{ github.event.inputs.additional_env_vars }}" ]; then
            echo "${{ github.event.inputs.additional_env_vars }}" | tr ',' '\n' >> envs/.env
          fi

          awk -F= '!seen[$1]++{line[NR]=$0; order[NR]=$1} {val[$1]=$0} END {for (i=1;i<=NR;i++) if (order[i] in val) {print val[order[i]]; delete val[order[i]]}}' envs/.env > envs/.env.tmp
          mv envs/.env.tmp envs/.env

      - name: Show final .env file
        run: cat envs/.env
