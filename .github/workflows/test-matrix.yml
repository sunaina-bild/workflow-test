name: Test Multi-Environment Deployment

on:
  workflow_dispatch:

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      envs: ${{ steps.set-matrix.outputs.envs }}
    steps:
      - name: Generate environment matrix from secret
        id: set-matrix
        run: |
          # convert comma-separated secret to JSON array
          JSON=$(echo "$DEPLOY_ENV_LIST" | sed 's/,/","/g')
          echo "envs=[\"$JSON\"]" >> $GITHUB_OUTPUT
        env:
          DEPLOY_ENV_LIST: ${{ secrets.DEPLOY_ENV_LIST }}

  deploy:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ fromJSON(needs.prepare-matrix.outputs.envs) }}
    steps:
      - name: Print environment info
        run: |
          echo "=============================="
          echo "Simulating deploy to: ${{ matrix.environment }}"
          # calculate hash of secret
          HASH=$(echo -n "${{ secrets.MY_SECRET }}" | sha256sum | awk '{print $1}')
          echo "Hash of MY_SECRET: $HASH"
          echo "âœ… Done with ${{ matrix.environment }}"
          echo "=============================="
